<?php

describe("Smart contract ", function () {

    beforeEach(function(){
        $smartContractBinaries = "6060604052341561000f57600080fd5b604051606080610be483398101604052808051906020019091908051906020019091908051906020019091905050826002819055508160018190555080600081905550806004819055506000600360006101000a81548160ff0219169083151502179055507f0114aab713235b737f82de882833e128d244e12c1b0967b9c49748c123a6f4b183838360405180848152602001838152602001828152602001935050505060405180910390a1505050610b17806100cd6000396000f3006060604052600436106100e6576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630b97bc86146100eb5780630f76787214610114578063164418131461013d5780632014e5d1146101745780634423c5f1146101a1578063454a2ab31461021d5780634c051f1414610258578063544736e6146102ad5780636f52a711146102da5780637b3529621461030357806382dd9b7714610330578063971c92a814610360578063bef4876b14610389578063c24a0f8b146103b6578063e53dbd7a146103df578063efbe1c1c14610408575b600080fd5b34156100f657600080fd5b6100fe610435565b6040518082815260200191505060405180910390f35b341561011f57600080fd5b61012761043b565b6040518082815260200191505060405180910390f35b341561014857600080fd5b610150610441565b60405180848152602001838152602001828152602001935050505060405180910390f35b341561017f57600080fd5b61018761045a565b604051808215151515815260200191505060405180910390f35b34156101ac57600080fd5b6101c2600480803590602001909190505061047a565b604051808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018481526020018381526020018215151515815260200194505050505060405180910390f35b341561022857600080fd5b61023e60048080359060200190919050506104e6565b604051808215151515815260200191505060405180910390f35b341561026357600080fd5b61026b6107e6565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156102b857600080fd5b6102c0610890565b604051808215151515815260200191505060405180910390f35b34156102e557600080fd5b6102ed61089d565b6040518082815260200191505060405180910390f35b341561030e57600080fd5b6103166108a3565b604051808215151515815260200191505060405180910390f35b341561033b57600080fd5b6103436108c6565b604051808381526020018281526020019250505060405180910390f35b341561036b57600080fd5b61037361095e565b6040518082815260200191505060405180910390f35b341561039457600080fd5b61039c610963565b604051808215151515815260200191505060405180910390f35b34156103c157600080fd5b6103c9610976565b6040518082815260200191505060405180910390f35b34156103ea57600080fd5b6103f261097c565b6040518082815260200191505060405180910390f35b341561041357600080fd5b61041b610981565b604051808215151515815260200191505060405180910390f35b60015481565b60025481565b6000806000600154925060005491506004549050909192565b6000610464610890565b801561047557506104736108a3565b155b905090565b60058181548110151561048957fe5b90600052602060002090600402016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154908060020154908060030160009054906101000a900460ff16905084565b6000806104f16108c6565b9150506104fc61045a565b151561050b57600091506107e0565b8083101561063557600580548060010182816105279190610a4f565b916000526020600020906004020160006080604051908101604052803273ffffffffffffffffffffffffffffffffffffffff16815260200187815260200142815260200160001515815250909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff0219169083151502179055505050507f3f3880a3434edc55799b6fa2eb84de9f6b4364947a45ded791bac94deae3c0a1836040518082815260200191505060405180910390a1600091506107e0565b600580548060010182816106499190610a4f565b916000526020600020906004020160006080604051908101604052803273ffffffffffffffffffffffffffffffffffffffff16815260200187815260200142815260200160011515815250909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff0219169083151502179055505050507fd04f845137f741f1b1fcb8758a097aa384274dde474ea57dc4b71e88f8625cf3838232604051808481526020018381526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001935050505060405180910390a160b4600054034211156107db5760b442016000819055507fe95bc45419aec7c2c587ae26906bc5d0cd55ce4237d73476f63bc13b36b149556000546040518082815260200191505060405180910390a15b600191505b50919050565b60008060058054905090505b60008114151561088b5760056001820381548110151561080e57fe5b906000526020600020906004020160030160009054906101000a900460ff161561087d5760056001820381548110151561084457fe5b906000526020600020906004020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16915061088c565b8080600190039150506107f2565b5b5090565b6000600154421015905090565b60045481565b6000600360009054906101000a900460ff16806108c1575060005442115b905090565b600080600060058054905090505b600081141515610953576005600182038154811015156108f057fe5b906000526020600020906004020160030160009054906101000a900460ff16156109455760056001820381548110151561092657fe5b9060005260206000209060040201600101549250600183019150610959565b8080600190039150506108d4565b60025491505b509091565b60b481565b600360009054906101000a900460ff1681565b60005481565b60b481565b600080600360009054906101000a900460ff16806109a0575060005442105b156109ae5760009150610a4b565b6001600360006101000a81548160ff0219169083151502179055506109d16108c6565b5090507f8b1ad6c69d3d79a05f5b1ec0de825e9bf67c6c70b8c25babd159976cf9990dff6109fd6107e6565b82604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a1600191505b5090565b815481835581811511610a7c57600402816004028360005260206000209182019101610a7b9190610a81565b5b505050565b610ae891905b80821115610ae457600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000905560028201600090556003820160006101000a81549060ff021916905550600401610a87565b5090565b905600a165627a7a72305820754c1010acd9d786231fb46d9cddd36ece3750a041ba8f62c211cccbe25c2c200029";
        $smartContractAbi = "[{\"constant\":true,\"inputs\":[],\"name\":\"startDate\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"startAmount\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"getDates\",\"outputs\":[{\"name\":\"_startDate\",\"type\":\"uint256\"},{\"name\":\"_endDate\",\"type\":\"uint256\"},{\"name\":\"_originalEndDate\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"isRunning\",\"outputs\":[{\"name\":\"_running\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"bids\",\"outputs\":[{\"name\":\"user\",\"type\":\"address\"},{\"name\":\"amount\",\"type\":\"uint256\"},{\"name\":\"date\",\"type\":\"uint256\"},{\"name\":\"accepted\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"_amount\",\"type\":\"uint256\"}],\"name\":\"bid\",\"outputs\":[{\"name\":\"\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"getLeader\",\"outputs\":[{\"name\":\"_leader\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"isStarted\",\"outputs\":[{\"name\":\"_started\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"originalEndDate\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"isFinished\",\"outputs\":[{\"name\":\"_finished\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"getCurrentAmounts\",\"outputs\":[{\"name\":\"_current\",\"type\":\"uint256\"},{\"name\":\"_minimal\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"antiSnippingTriggerPeriod\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"finished\",\"outputs\":[{\"name\":\"\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"endDate\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"antiSnippingDuration\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"end\",\"outputs\":[{\"name\":\"\",\"type\":\"bool\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"name\":\"_startAmount\",\"type\":\"uint256\"},{\"name\":\"_startDate\",\"type\":\"uint256\"},{\"name\":\"_endDate\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"startAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"startDate\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"endDate\",\"type\":\"uint256\"}],\"name\":\"NewAuction\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"winner\",\"type\":\"address\"},{\"indexed\":false,\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"AuctionFinished\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"amount\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"_minimal\",\"type\":\"uint256\"},{\"indexed\":false,\"name\":\"origin\",\"type\":\"address\"}],\"name\":\"BidAccepted\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"BidRejected\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"endDate\",\"type\":\"uint256\"}],\"name\":\"AntiSnippingTriggered\",\"type\":\"event\"}]";

        $this->sc = new \EthereumRawTx\SmartContract($smartContractBinaries, $smartContractAbi);

        $this->chainId = \BitWasp\Buffertools\Buffer::int(4); // rinkeby

        $this->privateKey = BitWasp\Buffertools\Buffer::hex('0000000000000000000000000000000000000000000000000000000000000001');


    });

    it("Deploy", function () {

        $time = 1511775500; // timestamp

        $tx = new \EthereumRawTx\Transaction(
            null,
            null,
            $this->sc->getConstructBin([\BitWasp\Buffertools\Buffer::int(5), \BitWasp\Buffertools\Buffer::int($time), \BitWasp\Buffertools\Buffer::int($time + 86400)]),
            BitWasp\Buffertools\Buffer::int('0'),
            \BitWasp\Buffertools\Buffer::int(40000000000),
            \BitWasp\Buffertools\Buffer::int(1000000)
        );

        $raw = $tx->getRaw(BitWasp\Buffertools\Buffer::hex('0000000000000000000000000000000000000000000000000000000000000001'), $this->chainId);

        expect($raw->getHex())->to->equal('f90c97808509502f9000830f42408080b90c446060604052341561000f57600080fd5b604051606080610be483398101604052808051906020019091908051906020019091908051906020019091905050826002819055508160018190555080600081905550806004819055506000600360006101000a81548160ff0219169083151502179055507f0114aab713235b737f82de882833e128d244e12c1b0967b9c49748c123a6f4b183838360405180848152602001838152602001828152602001935050505060405180910390a1505050610b17806100cd6000396000f3006060604052600436106100e6576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630b97bc86146100eb5780630f76787214610114578063164418131461013d5780632014e5d1146101745780634423c5f1146101a1578063454a2ab31461021d5780634c051f1414610258578063544736e6146102ad5780636f52a711146102da5780637b3529621461030357806382dd9b7714610330578063971c92a814610360578063bef4876b14610389578063c24a0f8b146103b6578063e53dbd7a146103df578063efbe1c1c14610408575b600080fd5b34156100f657600080fd5b6100fe610435565b6040518082815260200191505060405180910390f35b341561011f57600080fd5b61012761043b565b6040518082815260200191505060405180910390f35b341561014857600080fd5b610150610441565b60405180848152602001838152602001828152602001935050505060405180910390f35b341561017f57600080fd5b61018761045a565b604051808215151515815260200191505060405180910390f35b34156101ac57600080fd5b6101c2600480803590602001909190505061047a565b604051808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018481526020018381526020018215151515815260200194505050505060405180910390f35b341561022857600080fd5b61023e60048080359060200190919050506104e6565b604051808215151515815260200191505060405180910390f35b341561026357600080fd5b61026b6107e6565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156102b857600080fd5b6102c0610890565b604051808215151515815260200191505060405180910390f35b34156102e557600080fd5b6102ed61089d565b6040518082815260200191505060405180910390f35b341561030e57600080fd5b6103166108a3565b604051808215151515815260200191505060405180910390f35b341561033b57600080fd5b6103436108c6565b604051808381526020018281526020019250505060405180910390f35b341561036b57600080fd5b61037361095e565b6040518082815260200191505060405180910390f35b341561039457600080fd5b61039c610963565b604051808215151515815260200191505060405180910390f35b34156103c157600080fd5b6103c9610976565b6040518082815260200191505060405180910390f35b34156103ea57600080fd5b6103f261097c565b6040518082815260200191505060405180910390f35b341561041357600080fd5b61041b610981565b604051808215151515815260200191505060405180910390f35b60015481565b60025481565b6000806000600154925060005491506004549050909192565b6000610464610890565b801561047557506104736108a3565b155b905090565b60058181548110151561048957fe5b90600052602060002090600402016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154908060020154908060030160009054906101000a900460ff16905084565b6000806104f16108c6565b9150506104fc61045a565b151561050b57600091506107e0565b8083101561063557600580548060010182816105279190610a4f565b916000526020600020906004020160006080604051908101604052803273ffffffffffffffffffffffffffffffffffffffff16815260200187815260200142815260200160001515815250909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff0219169083151502179055505050507f3f3880a3434edc55799b6fa2eb84de9f6b4364947a45ded791bac94deae3c0a1836040518082815260200191505060405180910390a1600091506107e0565b600580548060010182816106499190610a4f565b916000526020600020906004020160006080604051908101604052803273ffffffffffffffffffffffffffffffffffffffff16815260200187815260200142815260200160011515815250909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff0219169083151502179055505050507fd04f845137f741f1b1fcb8758a097aa384274dde474ea57dc4b71e88f8625cf3838232604051808481526020018381526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001935050505060405180910390a160b4600054034211156107db5760b442016000819055507fe95bc45419aec7c2c587ae26906bc5d0cd55ce4237d73476f63bc13b36b149556000546040518082815260200191505060405180910390a15b600191505b50919050565b60008060058054905090505b60008114151561088b5760056001820381548110151561080e57fe5b906000526020600020906004020160030160009054906101000a900460ff161561087d5760056001820381548110151561084457fe5b906000526020600020906004020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16915061088c565b8080600190039150506107f2565b5b5090565b6000600154421015905090565b60045481565b6000600360009054906101000a900460ff16806108c1575060005442115b905090565b600080600060058054905090505b600081141515610953576005600182038154811015156108f057fe5b906000526020600020906004020160030160009054906101000a900460ff16156109455760056001820381548110151561092657fe5b9060005260206000209060040201600101549250600183019150610959565b8080600190039150506108d4565b60025491505b509091565b60b481565b600360009054906101000a900460ff1681565b60005481565b60b481565b600080600360009054906101000a900460ff16806109a0575060005442105b156109ae5760009150610a4b565b6001600360006101000a81548160ff0219169083151502179055506109d16108c6565b5090507f8b1ad6c69d3d79a05f5b1ec0de825e9bf67c6c70b8c25babd159976cf9990dff6109fd6107e6565b82604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a1600191505b5090565b815481835581811511610a7c57600402816004028360005260206000209182019101610a7b9190610a81565b5b505050565b610ae891905b80821115610ae457600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000905560028201600090556003820160006101000a81549060ff021916905550600401610a87565b5090565b905600a165627a7a72305820754c1010acd9d786231fb46d9cddd36ece3750a041ba8f62c211cccbe25c2c2000290000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000005a1bdd0c000000000000000000000000000000000000000000000000000000005a1d2e8c2ca04a7aa5dbe4b9de6425985e9ff4d6bce59774d6f27c253127d943edb7ed9e3360a021519ac7fdc6c6c3f901af32308f69736bd2c841aa37d73e79b2e39180d9096b');

    });

    it("Decode response", function () {

        $responseRaw = "0x000000000000000000000000000000000000000000000000000000005a16e154000000000000000000000000000000000000000000000000000000005a1832d4000000000000000000000000000000000000000000000000000000005a1832d4";
        $reponseData = $this->sc->decodeMethodResponse("getDates", $responseRaw);

        expect($reponseData['_startDate']->getInt())->to->equal('1511448916');
        expect($reponseData['_endDate']->getInt())->to->equal('1511535316');
        expect($reponseData['_originalEndDate']->getInt())->to->equal('1511535316');

        $responseRaw = "0x000000000000000000000000e9875966d7d6490592db866f815faf6fa94225a6";
        $reponseData = $this->sc->decodeMethodResponse("getLeader", $responseRaw);

        expect($reponseData['_leader']->getHex())->to->equal('e9875966d7d6490592db866f815faf6fa94225a6');

        $responseRaw = "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005";
        $reponseData = $this->sc->decodeMethodResponse("getCurrentAmounts", $responseRaw);

        expect($reponseData['_current']->getInt())->to->equal('0');
        expect($reponseData['_minimal']->getInt())->to->equal('5');

    });

    it("Decode response event", function () {

        $responseRaw = json_decode('{"address":"0x31b83a851eb7112448d4837a071acabd83531f69","topics":["0xd04f845137f741f1b1fcb8758a097aa384274dde474ea57dc4b71e88f8625cf3"],"data":"0x000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000026000000000000000000000000e78102df96419cd9c44d6bd8f14ea87712a3b479","blockNumber":"0x5577e","transactionHash":"0x1654c3343501d4cdb78ddd52da8e86c5f700ed13a8cdf71e7b6544b7483c8559","transactionIndex":"0x0","blockHash":"0x0b675c0fab32f0ab0221c309145b7b27571f335aa49518c05d71b4d8d1771a80","logIndex":"0x0","removed":false}',true);
        $reponseData = $this->sc->decodeEventResponse($responseRaw);

        expect($reponseData['eventName'])->to->equal('BidAccepted');
        expect($reponseData['data']['amount']->getInt())->to->equal('42');
        expect($reponseData['data']['_minimal']->getInt())->to->equal('38');
        expect($reponseData['data']['origin']->getHex())->to->equal('e78102df96419cd9c44d6bd8f14ea87712a3b479');

    });

});

